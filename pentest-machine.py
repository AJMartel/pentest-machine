#!/usr/bin/python

from libnmap.parser import NmapParser
import argparse
import subprocess
import os
import trollius
from trollius import From

'''
http: nikto, httpscreenshot, get comments
smb: enum4linux
ftp: Anonymous? brute?
mssql: brute sa? Do I want login bruteforcing?
smtp: smtp-open-relay + smtp-enum-users
snmp: bruteforce the string
'''

DN = open(os.devnull, 'w')
nikto_output = []

def parse_args():
	#Create the arguments
    parser = argparse.ArgumentParser()
    parser.add_argument("-f", "--nmapfile", help="Nmap XML file to parse")
    return parser.parse_args()

def main(args):
    report = NmapParser.parse_fromfile(args.nmapfile)
    for host in report.hosts:
        if host.is_up():
            print 'Host: {0} {1}'.format(host.address, host.hostnames)

        # Get services
        for s in host.services:
            print 'Service: {0}/{1} {2} {3}'.format(s.port, s.protocol, s.state, s.service)
            if s.service == 'http':
                nikto(host.address, s.port)

@trollius.coroutine
def nikto(ip, port):
    '''
    Run nikto on all http servers
    '''
    nikto = subprocess.Popen(['/usr/bin/nikto', '-h', '{0}:{1}'.format(ip, port)], stdout=subprocess.PIPE, stderr=DN)
    out = nikto.communicate()
    #with open('nikto-output.txt', 'a+') as nikto_output:
    #    for line in out:
    #        if line:
    #            nikto_output.write(line+'\n')

if __name__ == "__main__":
    main(parse_args())
